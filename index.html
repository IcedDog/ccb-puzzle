<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>词出变</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: #f0f0f0;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .game-setup {
            margin-bottom: 30px;
        }

        .setup-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .setup-item {
            flex: 1;
            min-width: 200px;
        }

        .setup-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .setup-item input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .setup-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn-settings {
            background: linear-gradient(45deg, #20bf6b, #01a3a4);
        }

        .game-area {
            display: none;
        }

        .game-area.active {
            display: block;
        }

        .game-status {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1em;
        }

        .character-bank {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .character-bank h3 {
            margin-bottom: 15px;
            color: #555;
        }

        .character-grid {
            display: flex;
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
            flex-wrap: wrap;
        }

        .character-bank-btn {
            background: #aaa;
            color: white;
            padding: 0px 4px;
            font-size: 12px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }

        .character-bank-btn:hover {
            background-color: #999;
        }

        .char-btn {
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 4px;
            height: 35px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            text-align: center;
            display: flex;
        }

        .char-btn:hover {
            background: #667eea;
            color: white;
        }

        .input-area {
            margin-bottom: 20px;
        }

        .input-area label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .input-container input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-error-text {
            background-color: #f8d7da;
        }

        .chat-history {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
        }

        .chat-history h3 {
            margin-bottom: 15px;
            color: #555;
        }

        .chat-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            padding: 15px;
        }

        .chat-placeholder {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-in;
        }

        .chat-message:last-child {
            margin-bottom: 0;
        }

        .message-user {
            text-align: right;
        }

        .message-ai {
            text-align: left;
        }

        .message-bubble {
            display: inline-block;
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-user .message-bubble {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .message-ai .message-bubble {
            background: #e9ecef;
            color: #333;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .input-warning {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .input-warning.show {
            display: block;
        }

        .input-container input.invalid {
            border-color: #e74c3c;
            background-color: #fdf2f2;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .settings-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;

            scrollbar-width: thin;
            scrollbar-color: #0000 #0000;
        }

        .settings-content::-webkit-scrollbar {
            width: 8px;
        }

        .settings-item {
            margin-bottom: 20px;
        }

        .settings-item input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .settings-item input[type="text"]:focus,
        input[type="password"]:focus {
            border: 2px solid #667eea;
            outline: none;
        }

        .settings-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .success-message {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .guide {
            background: #e8f4f8;
            border-left: 4px solid #00b894;
            padding: 15px;
            margin-bottom: 20px;
        }

        .guide h4 {
            margin-bottom: 10px;
            color: #00b894;
        }

        .guide ul {
            margin-left: 20px;
        }

        .guide li {
            margin-bottom: 5px;
        }

        .guide code {
            font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, serif;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 2px 6px;
            color: #333;
        }

        .guide a {
            color: #0984e3;
            text-decoration: none;
        }

        @media (max-width: 768px) {
            .setup-row {
                flex-direction: column;
            }

            .setup-item {
                min-width: 100%;
            }

            .character-grid {
                grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
            }
        }

        /* The snackbar - position it at the bottom and in the middle of the screen */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            top: 30px;
            border-radius: 15px;
        }

        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {
                top: 0;
                opacity: 0;
            }

            to {
                top: 30px;
                opacity: 1;
            }
        }

        @keyframes fadein {
            from {
                top: 0;
                opacity: 0;
            }

            to {
                top: 30px;
                opacity: 1;
            }
        }

        @-webkit-keyframes fadeout {
            from {
                top: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @keyframes fadeout {
            from {
                top: 30px;
                opacity: 1;
            }

            to {
                top: 0;
                opacity: 0;
            }
        }

        @keyframes confetti-slow {
            0% {
                transform: translate3d(0, 0, 0) rotateX(0) rotateY(0);
            }

            100% {
                transform: translate3d(25px, 105vh, 0) rotateX(360deg) rotateY(180deg);
            }
        }

        @keyframes confetti-medium {
            0% {
                transform: translate3d(0, 0, 0) rotateX(0) rotateY(0);
            }

            100% {
                transform: translate3d(100px, 105vh, 0) rotateX(100deg) rotateY(360deg);
            }
        }

        @keyframes confetti-fast {
            0% {
                transform: translate3d(0, 0, 0) rotateX(0) rotateY(0);
            }

            100% {
                transform: translate3d(-50px, 105vh, 0) rotateX(10deg) rotateY(250deg);
            }
        }

        .confetti-container {
            perspective: 700px;
            position: absolute;
            overflow: hidden;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .js-container {
            height: 100%;
            width: 100%;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            background-color: rgba(0, 0, 0, 0.0);
            overflow-x: hidden;
            transition: 0.5s;
            pointer-events: none;
        }

        .confetti {
            position: absolute;
            z-index: 2;
            top: 10px;
            border-radius: 0%;
        }

        .confetti--animation-slow {
            animation: confetti-slow 4.5s linear 1 forwards;
        }

        .confetti--animation-medium {
            animation: confetti-medium 3.5s linear 1 forwards;
        }

        .confetti--animation-fast {
            animation: confetti-fast 2.5s linear 1 forwards;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="title">言语笑传之词出变</h1>
            <p class="subtitle">出了吗？没出？</p>
        </div>

        <div class="main-content">
            <div class="game-setup" id="gameSetup">
                <div class="setup-row">
                    <div class="setup-item">
                        <label for="initialChars">初始字库：</label>
                        <input type="text" id="initialChars" placeholder="输入初始可用字符" value="">
                    </div>
                    <div class="setup-item">
                        <label for="targetWord">目标词：</label>
                        <input type="text" id="targetWord" placeholder="输入目标词汇" value="">
                    </div>
                </div>
                <div class="setup-row">
                    <button class="btn" onclick="startGame()">开始游戏</button>
                    <button class="btn btn-settings" onclick="openSettings()">设置</button>
                </div>
            </div>

            <div class="game-area" id="gameArea">
                <div class="game-status" id="gameStatus">
                    目标词：<span id="currentTarget"></span>
                </div>

                <div class="character-bank">
                    <h3>
                        可用字库 (<span id="charCount">0</span>个字符)
                        <button class="character-bank-btn" onclick="copyBank()">复制字库</button>
                        <button class="character-bank-btn" onclick="pasteBank()">粘贴字库</button>
                    </h3>
                    <div class="character-grid" id="characterGrid"></div>
                </div>

                <div class="input-area">
                    <label for="userInput">输入提问内容：</label>
                    <div class="input-container">
                        <input type="text" id="userInput" placeholder="使用字库中的字符进行提问">
                        <button class="btn" onclick="submitQuestion()" id="submitBtn">提交</button>
                        <button class="btn btn-secondary" onclick="clearInput()">清空</button>
                    </div>
                    <div class="input-warning" id="inputWarning">包含非法字符，无法发送：</div>
                </div>

                <div class="chat-history">
                    <h3>聊天记录：</h3>
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-placeholder">开始提问来查看聊天记录...</div>
                    </div>
                </div>

                <div class="setup-row">
                    <button class="btn btn-secondary" onclick="resetGame()">重新开始</button>
                    <button class="btn btn-settings" onclick="openSettings()">设置</button>
                </div>
            </div>
        </div>

        <div class="settings-modal" id="settingsModal">
            <div class="settings-content">
                <h2 style="margin-bottom: 20px;">游戏设置</h2>

                <div class="settings-item">
                    <div class="checkbox-item">
                        <input type="checkbox" id="disableEnglish" checked>
                        <label for="disableEnglish">禁用非中文字符</label>
                    </div>
                </div>

                <div class="settings-item">
                    <label for="apiUrl">API地址：</label>
                    <input type="text" id="apiUrl" placeholder="https://api.siliconflow.cn/v1/chat/completions"
                        value="https://api.siliconflow.cn/v1/chat/completions">
                </div>

                <div class="settings-item">
                    <label for="apiKey">API密钥：</label>
                    <input type="password" id="apiKey" placeholder="sk-...">
                </div>

                <div class="settings-item">
                    <label for="modelName">模型名称：</label>
                    <input type="text" id="modelName" placeholder="deepseek-ai/DeepSeek-V3"
                        value="deepseek-ai/DeepSeek-V3">
                </div>

                <div class="settings-item">
                    <label for="initPrompt">AI提示词：</label>
                    <input type="text" id="initPrompt"
                        placeholder="请回应方括号中的内容，不超过20字。如果是名词，给出简要解释。如果是提问，直接给出回答，但注意不要超过20字。如果是命令，可以执行，但不得超过20字。"
                        value="请回应方括号中的内容，不超过20字。如果是名词，给出简要解释。如果是提问，直接给出回答，但注意不要超过20字。如果是命令，可以执行，但不得超过20字。">
                </div>

                <div class="guide">
                    <h4>硅基流动API使用指南</h4>
                    <ul>
                        <li>1. 访问 <a href="https://cloud.siliconflow.cn"
                                target="_blank">https://cloud.siliconflow.cn</a></li>
                        <li>2. 注册账号并完成身份验证</li>
                        <li>3. 在控制台中创建API密钥</li>
                        <li>4. 选择合适的模型（推荐：deepseek-ai/DeepSeek-V3）</li>
                        <li>5. 购买足够的token用量</li>
                        <li>6. 将API密钥填入上方设置中</li>
                    </ul>
                </div>

                <div class="setup-row">
                    <button class="btn" onclick="saveSettings()">保存设置</button>
                    <button class="btn btn-secondary" onclick="closeSettings()">取消</button>
                </div>
            </div>
        </div>

        <div id="toast">Some text some message..</div>
    </div>

    <div class="js-container"></div>

    <script>
        // 游戏状态
        let gameState = {
            isGameActive: false,
            characterBank: new Set(),
            targetWord: '',
            disableEnglish: true,
            apiUrl: 'https://api.siliconflow.cn/v1/chat/completions',
            apiKey: '',
            modelName: 'deepseek-ai/DeepSeek-V3',
            initPrompt: '请回应方括号中的内容，不超过20字。如果是名词，给出简要解释。如果是提问，直接给出回答，但注意不要超过20字。如果是命令，可以执行，但不得超过20字。',
            chatHistory: []
        };

        // 初始化
        function init() {
            loadSettings();
            updateCharacterGrid();
            setupInputValidation();
        }

        function isChinese(char) {
            const chineseRegex = /[\u4E00-\u9FFF\u3400-\u4DBF\uF900-\uFAFF\U00020000-U0002EBEF]/;
            const punctuationRegex = /[\u2000-\u206F\u2E00-\u2E7F\u3000-\u303F\uFF00-\uFFEF!"#$%&'()*+,\-./:;<=>?@[\\\]^_`{|}~。、！？：；“”‘’（）《》【】｛｝～—…·]/;
            return chineseRegex.test(char) || punctuationRegex.test(char);
        }

        // 设置输入验证
        function setupInputValidation() {
            const input = document.getElementById('userInput');
            const warning = document.getElementById('inputWarning');
            const submitBtn = document.getElementById('submitBtn');

            input.addEventListener('input', function () {
                if (!gameState.isGameActive) return;

                const text = this.value;
                const isValid = validateInput(text);

                if (text && isValid !== "") {
                    this.classList.add('invalid');
                    warning.classList.add('show');
                    warning.textContent = `包含非法字符，无法发送：${isValid}`;
                    submitBtn.disabled = true;
                } else {
                    this.classList.remove('invalid');
                    warning.classList.remove('show');
                    submitBtn.disabled = false;
                }
            });
        }

        // 开始游戏
        function startGame() {
            const initialChars = document.getElementById('initialChars').value.trim();
            const targetWord = document.getElementById('targetWord').value.trim();

            if (!initialChars || !targetWord) {
                showToast('请输入初始字库和目标词', "#e74c3c");
                return;
            }

            if (!gameState.apiKey) {
                showToast('请先在设置中配置API密钥', "#e74c3c");
                openSettings();
                return;
            }

            // 初始化游戏状态
            gameState.isGameActive = true;
            gameState.targetWord = targetWord;
            gameState.characterBank = new Set();

            // 添加初始字符到字库
            for (let char of initialChars) {
                if (gameState.disableEnglish && !isChinese(char)) {
                    continue;
                }
                gameState.characterBank.add(char);
            }

            // 更新界面
            document.getElementById('gameSetup').style.display = 'none';
            document.getElementById('gameArea').classList.add('active');
            document.getElementById('currentTarget').textContent = targetWord;
            updateCharacterGrid();
            clearInput();
            clearChatHistory();

            // 重置输入验证状态
            const input = document.getElementById('userInput');
            const warning = document.getElementById('inputWarning');
            const submitBtn = document.getElementById('submitBtn');
            input.classList.remove('invalid');
            warning.classList.remove('show');
            submitBtn.disabled = false;
        }

        // 更新字符网格
        function updateCharacterGrid() {
            const grid = document.getElementById('characterGrid');
            const charCount = document.getElementById('charCount');

            grid.innerHTML = '';
            charCount.textContent = gameState.characterBank.size;

            const sortedChars = Array.from(gameState.characterBank).sort();
            sortedChars.forEach(char => {
                const btn = document.createElement('button');
                btn.className = 'char-btn';
                btn.textContent = char;
                btn.onclick = () => addCharToInput(char);
                grid.appendChild(btn);
            });
        }

        // 添加字符到输入框
        function addCharToInput(char) {
            const input = document.getElementById('userInput');
            input.value += char;
        }

        // 清空输入
        function clearInput() {
            document.getElementById('userInput').value = '';
        }

        // 添加聊天记录
        function addChatMessage(content, isUser = false) {
            const chatContainer = document.getElementById('chatContainer');
            const placeholder = chatContainer.querySelector('.chat-placeholder');

            // 移除占位符
            if (placeholder) {
                placeholder.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'message-user' : 'message-ai'}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = content;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString();

            messageDiv.appendChild(bubbleDiv);
            messageDiv.appendChild(timeDiv);
            chatContainer.appendChild(messageDiv);

            // 滚动到底部
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // 添加到历史记录
            gameState.chatHistory.push({
                content: content,
                isUser: isUser,
                timestamp: new Date().toISOString()
            });
        }

        // 清空聊天记录
        function clearChatHistory() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '<div class="chat-placeholder">开始提问来查看聊天记录...</div>';
            gameState.chatHistory = [];
        }

        // 显示加载消息
        function showLoadingMessage() {
            const chatContainer = document.getElementById('chatContainer');
            const placeholder = chatContainer.querySelector('.chat-placeholder');

            if (placeholder) {
                placeholder.remove();
            }

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message message-ai';
            loadingDiv.id = 'loadingMessage';

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.innerHTML = '<em>AI正在思考中...</em>';

            loadingDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(loadingDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 移除加载消息
        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // 验证输入
        function validateInput(text) {
            let ret = new Set();
            for (let char of text) {
                if (!gameState.characterBank.has(char)) {
                    ret.add(char);
                }
            }
            return ret.size > 0 ? [...ret] : ""
        }

        // 提交问题
        async function submitQuestion() {
            const input = document.getElementById('userInput');
            const question = input.value.trim();

            if (!question) {
                showToast('请输入问题', "#e74c3c");
                return;
            }

            if (validateInput(question) !== "") {
                showToast('输入包含字库中没有的字符', "#e74c3c");
                return;
            }

            // 添加用户消息到聊天记录
            addChatMessage(question, true);

            // 禁用提交按钮
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';

            // 显示加载消息
            showLoadingMessage();

            try {
                const response = await callAI(question);

                // 移除加载消息并添加AI回复
                removeLoadingMessage();
                addChatMessage(response, false);

                // 将回复中的字符添加到字库
                addResponseToBank(response);
                updateCharacterGrid();

                // 检查是否达成目标
                if (checkWinCondition(response)) {
                    showSuccess();
                }

                // 清空输入
                clearInput();
            } catch (error) {
                removeLoadingMessage();
                showToast('请求失败：' + error.message, "#e74c3c");
            } finally {
                // 恢复提交按钮
                submitBtn.disabled = false;
                submitBtn.textContent = '提交';
            }
        }

        // 调用AI API
        async function callAI(question) {
            const response = await fetch(gameState.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${gameState.apiKey}`
                },
                body: JSON.stringify({
                    model: gameState.modelName,
                    messages: [
                        {
                            role: 'user',
                            content: `${gameState.initPrompt}\n[${question}]`
                        }
                    ],
                    max_tokens: 100,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        // 将回复添加到字库
        function addResponseToBank(response) {
            for (let char of response) {
                if (gameState.disableEnglish && !isChinese(char)) {
                    continue;
                }
                gameState.characterBank.add(char);
            }
        }

        // 检查胜利条件
        function checkWinCondition(response) {
            return response.includes(gameState.targetWord);
        }

        // 显示成功消息
        function showSuccess() {
            const gameArea = document.getElementById('gameArea');
            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.innerHTML = `🎉 恭喜！成功挑战完成！<br>AI回复中包含了目标词"${gameState.targetWord}"`;
            gameArea.insertBefore(successMsg, gameArea.firstChild);

            spawnConfetti(3000);

            // 禁用提交按钮
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = '挑战已完成';
        }

        // 重置游戏
        function resetGame() {
            gameState.isGameActive = false;
            gameState.characterBank = new Set();
            gameState.targetWord = '';
            gameState.chatHistory = [];

            document.getElementById('gameSetup').style.display = 'block';
            document.getElementById('gameArea').classList.remove('active');

            // 移除成功消息
            const successMsg = document.querySelector('.success-message');
            if (successMsg) {
                successMsg.remove();
            }

            // 重置输入状态
            const input = document.getElementById('userInput');
            const warning = document.getElementById('inputWarning');
            const submitBtn = document.getElementById('submitBtn');
            input.classList.remove('invalid');
            warning.classList.remove('show');
            submitBtn.disabled = false;
            submitBtn.textContent = '提交';
        }

        // 打开设置
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        // 关闭设置
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // 保存设置
        function saveSettings() {
            gameState.disableEnglish = document.getElementById('disableEnglish').checked;
            gameState.apiUrl = document.getElementById('apiUrl').value.trim();
            gameState.apiKey = document.getElementById('apiKey').value.trim();
            gameState.modelName = document.getElementById('modelName').value.trim();
            gameState.initPrompt = document.getElementById('initPrompt').value.trim();

            // 保存到localStorage
            localStorage.setItem('gameSettings', JSON.stringify({
                disableEnglish: gameState.disableEnglish,
                apiUrl: gameState.apiUrl,
                apiKey: gameState.apiKey,
                modelName: gameState.modelName,
                initPrompt: gameState.initPrompt
            }));

            closeSettings();
            showToast('设置已保存', '#2ecc71');
        }

        // 加载设置
        function loadSettings() {
            const saved = localStorage.getItem('gameSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                gameState.disableEnglish = settings.disableEnglish ?? true;
                gameState.apiUrl = settings.apiUrl || 'https://api.siliconflow.cn/v1/chat/completions';
                gameState.apiKey = settings.apiKey || '';
                gameState.modelName = settings.modelName || 'deepseek-ai/DeepSeek-V3';
                gameState.initPrompt = settings.initPrompt || '请回应方括号中的内容，不超过20字。如果是名词，给出简要解释。如果是提问，直接给出回答，但注意不要超过20字。如果是命令，可以执行，但不得超过20字。';

                // 更新界面
                document.getElementById('disableEnglish').checked = gameState.disableEnglish;
                document.getElementById('apiUrl').value = gameState.apiUrl;
                document.getElementById('apiKey').value = gameState.apiKey;
                document.getElementById('modelName').value = gameState.modelName;
                document.getElementById('initPrompt').value = gameState.initPrompt;
            }
        }

        // 键盘事件
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('userInput').value && gameState.isGameActive) {
                const input = document.getElementById('userInput');
                const submitBtn = document.getElementById('submitBtn');

                // 只有在输入有效且提交按钮可用时才提交
                if (!input.classList.contains('invalid') && !submitBtn.disabled) {
                    submitQuestion();
                }
            }
        });

        function copyBank() {
            const bank = Array.from(gameState.characterBank).join('');
            navigator.clipboard.writeText(bank).then(() => {
                showToast('字库已复制到剪贴板', '#2ecc71');
            }).catch(err => {
                showToast('复制失败: ' + err, '#e74c3c');
            });
        }

        function pasteBank() {
            const inBank = navigator.clipboard.readText().then(text => {
                const chars = new Set(text.trim().split(''));
                gameState.characterBank = new Set();
                for (let char of chars) {
                    if (gameState.disableEnglish && !isChinese(char)) {
                        continue;
                    }
                    gameState.characterBank.add(char);
                }
                updateCharacterGrid();
                showToast('字库已粘贴', '#2ecc71');
            }).catch(err => {
                showToast('粘贴失败: ' + err, '#e74c3c');
            });
        }

        function showToast(str, color) {
            const x = document.getElementById("toast");
            x.className = "show";
            x.style.backgroundColor = color;
            x.innerHTML = str;
            setTimeout(function () { x.className = x.className.replace("show", ""); }, 3000);
        }

        const Confettiful = function (el) {
            this.el = el;
            this.containerEl = null;

            this.confettiFrequency = 3;
            this.confettiColors = ['#EF2964', '#00C09D', '#2D87B0', '#48485E', '#EFFF1D'];
            this.confettiAnimations = ['slow', 'medium', 'fast'];

            this._setupElements();
        };

        Confettiful.prototype._setupElements = function () {
            const containerEl = document.createElement('div');
            const elPosition = this.el.style.position;

            containerEl.classList.add('confetti-container');

            this.el.appendChild(containerEl);

            this.containerEl = containerEl;
        };

        Confettiful.prototype._renderConfetti = function () {
            this.confettiInterval = setInterval(() => {
                const confettiEl = document.createElement('div');
                const confettiSize = (Math.floor(Math.random() * 3) + 7) + 'px';
                const confettiBackground = this.confettiColors[Math.floor(Math.random() * this.confettiColors.length)];
                const confettiLeft = (Math.floor(Math.random() * this.el.offsetWidth)) + 'px';
                const confettiAnimation = this.confettiAnimations[Math.floor(Math.random() * this.confettiAnimations.length)];

                confettiEl.classList.add('confetti', 'confetti--animation-' + confettiAnimation);
                confettiEl.style.left = confettiLeft;
                confettiEl.style.width = confettiSize;
                confettiEl.style.height = confettiSize;
                confettiEl.style.backgroundColor = confettiBackground;

                confettiEl.removeTimeout = setTimeout(function () {
                    confettiEl.parentNode.removeChild(confettiEl);
                }, 3000);

                this.containerEl.appendChild(confettiEl);
            }, 25);
        };

        Confettiful.prototype._stopConfetti = function () {
            clearInterval(this.confettiInterval);
        };

        const confettiElement = document.getElementsByClassName('js-container')[0];
        const confetti = new Confettiful(confettiElement);

        function spawnConfetti(timeout = 2000) {
            confetti._renderConfetti();
            setTimeout(() => {
                confetti._stopConfetti();
            }, timeout);
        }

        // 初始化
        init();
    </script>
</body>

</html>